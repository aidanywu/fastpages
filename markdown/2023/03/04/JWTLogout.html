<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">JWT Logout</h1><p class="page-description">Implementing logout into spring boot project</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2023-03-04T00:00:00-06:00" itemprop="datePublished">
        Mar 4, 2023
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      2 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/fastpages/categories/#markdown">markdown</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#logout">Logout</a>
<ul>
<li class="toc-entry toc-h3"><a href="#database-approach">Database Approach</a>
<ul>
<li class="toc-entry toc-h4"><a href="#postman-testing">Postman Testing</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#cache-approach">Cache Approach</a></li>
</ul>
</li>
</ul><h2 id="logout">
<a class="anchor" href="#logout" aria-hidden="true"><span class="octicon octicon-link"></span></a>Logout</h2>
<p>For logout to work properly, there are two main jobs the logout request has to do: (1) remove the existing JWT cookie on the user’s browser, and (2) stop the user from using the same JWT to access server resources.</p>

<p>Removing the existing JWT cookie is easy, we simply have to return a new cookie with the key “jwt” and a Max-Age of 0. This will replace the JWT cookie on the user’s browser and expire instantly.</p>

<p>To stop the user from using the same JWT, we have to store expired JWTs somewhere on the server. Two ways to do this are to use cache or another table inside the existing database.</p>

<h3 id="database-approach">
<a class="anchor" href="#database-approach" aria-hidden="true"><span class="octicon octicon-link"></span></a>Database Approach</h3>
<p>First, we need to create a table inside the database that stores the logged out JWTs. An API Controller that allows you to get all the blacklisted JWTs with /blacklist/ and to logout by saving the JWT into the blacklist and is created as well.
The above is done in <a href="https://github.com/aidanywu/spring_port/commit/187159326cd48d0e77dfc6fe6efa7ac832f79aca">commit</a></p>

<p>Next, we need to check if every request’s JWT token is inside the blacklist. If so, the request should return unauthorized because they shouldn’t be able to use a JWT they have already logged out with to be authenticated.
This is done in <a href="https://github.com/aidanywu/spring_port/commit/d6d3a60e10ad0d8e9c2390fdc6e0773cb38f5ca2">commit</a>.
(Note: I also made each JWT to expire in 1 hour instead of 5 hours when the user authenticates to match with the cookie Max-Age which is 1 hour.)</p>

<p>Finally, if we never go through the database to clear out blacklisted tokens that have already expired (so it is meaningless to keep the token in there because the user can’t be authenticated with an expired token anyways), it will stack up. We can use the scheduler annotation in spring boot to run the method that clears expired token out of the blacklist periodically. This is done in <a href="https://github.com/aidanywu/spring_port/commit/c282a2bf405588910eef0018b7cce522afcea629">commit</a>.
(Note: All these durations can be configured/changed at your convenience)</p>

<h4 id="postman-testing">
<a class="anchor" href="#postman-testing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Postman Testing</h4>
<p>Note: I made the JWT token to expire in 2 minute and the scheduler to run at every 30 seconds for testing convenience.</p>

<p>First, we authenticate to get a JWT token:
<img src="https://user-images.githubusercontent.com/56620132/222934688-644a7814-ea0b-4f4a-aec7-b2f6925474c8.png" alt="authenticating"></p>

<p>Then, we verify that the JWT token is working by /api/person/ which is restricted to only authenticated users:
<img src="https://user-images.githubusercontent.com/56620132/222934816-2083d794-f7f5-4ee8-8e97-97a38fdaff9f.png" alt="JWT works"></p>

<p>The blacklist is empty as of now because we haven’t logged out:
<img src="https://user-images.githubusercontent.com/56620132/222934731-b456508a-06df-48c8-b45f-4db844ea53dc.png" alt="blacklist pre-logout"></p>

<p>Now, we logout using /blacklist/logout with the JWT token stored in the Cookie header. The request returns a Set-Cookie header with an empty JWT cookie of Max-Age 0 to delete the existing client-side JWT cookie:
<img src="https://user-images.githubusercontent.com/56620132/222934706-d25092bb-2f12-45c1-badc-9f4ba2c39243.png" alt="logging out"></p>

<p>The logout request has taken the JWT token in our cookie header and stored it into the blacklist:
<img src="https://user-images.githubusercontent.com/56620132/222934833-9a2982b1-679b-46d9-8167-7089cc731ca9.png" alt="blacklist post-logout"></p>

<p>We can no longer access /api/person/ with the same JWT token because the server has checked that the JWT token is inside the blacklist and we should not be authenticated:
<img src="https://user-images.githubusercontent.com/56620132/222934752-17775720-04cc-4b32-b4b6-b07f109e3963.png" alt="JWT does not work"></p>

<p>Finally, to test the cleaning feature, we wait for 2 minutes or so until the scheduled task runs to delete the JWT token inside the blacklist which has now expired:
<img src="https://user-images.githubusercontent.com/56620132/222934843-c2f74df5-82c7-44f3-a75b-9a30ea1aa36e.png" alt="blacklist cleaned"></p>

<h3 id="cache-approach">
<a class="anchor" href="#cache-approach" aria-hidden="true"><span class="octicon octicon-link"></span></a>Cache Approach</h3>
<p>Not finished implementing yet</p>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="willcyber/fastpages"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/fastpages/markdown/2023/03/04/JWTLogout.html" hidden></a>
</article>
