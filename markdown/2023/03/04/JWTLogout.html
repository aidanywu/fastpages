<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>JWT Logout | fastpages</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="JWT Logout" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Implementing logout into spring boot project" />
<meta property="og:description" content="Implementing logout into spring boot project" />
<link rel="canonical" href="https://willcyber.github.io/fastpages/markdown/2023/03/04/JWTLogout.html" />
<meta property="og:url" content="https://willcyber.github.io/fastpages/markdown/2023/03/04/JWTLogout.html" />
<meta property="og:site_name" content="fastpages" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-03-04T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="JWT Logout" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-03-04T00:00:00-06:00","datePublished":"2023-03-04T00:00:00-06:00","description":"Implementing logout into spring boot project","headline":"JWT Logout","mainEntityOfPage":{"@type":"WebPage","@id":"https://willcyber.github.io/fastpages/markdown/2023/03/04/JWTLogout.html"},"url":"https://willcyber.github.io/fastpages/markdown/2023/03/04/JWTLogout.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/fastpages/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://willcyber.github.io/fastpages/feed.xml" title="fastpages" /><link rel="shortcut icon" type="image/x-icon" href="/fastpages/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/fastpages/">fastpages</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/fastpages/about/">About Me</a><a class="page-link" href="/fastpages/search/">Search</a><a class="page-link" href="/fastpages/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <h2 id="logout">Logout</h2>
<p>For logout to work properly, there are two main jobs the logout request has to do: (1) remove the existing JWT cookie on the user’s browser, and (2) stop the user from using the same JWT to access server resources.</p>

<p>Removing the existing JWT cookie is easy, we simply have to return a new cookie with the key “jwt” and a Max-Age of 0. This will replace the JWT cookie on the user’s browser and expire instantly.</p>

<p>To stop the user from using the same JWT, we have to store expired JWTs somewhere on the server. Two ways to do this are to use cache or another table inside the existing database.</p>

<h3 id="database-approach">Database Approach</h3>
<p>First, we need to create a table inside the database that stores the logged out JWTs. An API Controller that allows you to get all the blacklisted JWTs with /blacklist/ and to logout by saving the JWT into the blacklist and is created as well.
The above is done in <a href="https://github.com/aidanywu/spring_port/commit/187159326cd48d0e77dfc6fe6efa7ac832f79aca">commit</a></p>

<p>Next, we need to check if every request’s JWT token is inside the blacklist. If so, the request should return unauthorized because they shouldn’t be able to use a JWT they have already logged out with to be authenticated.
This is done in <a href="https://github.com/aidanywu/spring_port/commit/d6d3a60e10ad0d8e9c2390fdc6e0773cb38f5ca2">commit</a>.
(Note: I also made each JWT to expire in 1 hour instead of 5 hours when the user authenticates to match with the cookie Max-Age which is 1 hour.)</p>

<p>Finally, if we never go through the database to clear out blacklisted tokens that have already expired (so it is meaningless to keep the token in there because the user can’t be authenticated with an expired token anyways), it will stack up. We can use the scheduler annotation in spring boot to run the method that clears expired token out of the blacklist periodically. This is done in <a href="https://github.com/aidanywu/spring_port/commit/c282a2bf405588910eef0018b7cce522afcea629">commit</a>.
(Note: All these durations can be configured/changed at your convenience)</p>

<h4 id="postman-testing">Postman Testing</h4>
<p>Note: I made the JWT token to expire in 2 minute and the scheduler to run at every 30 seconds for testing convenience.</p>

<p>First, we authenticate to get a JWT token:
<img src="https://user-images.githubusercontent.com/56620132/222934688-644a7814-ea0b-4f4a-aec7-b2f6925474c8.png" alt="authenticating" /></p>

<p>Then, we verify that the JWT token is working by /api/person/ which is restricted to only authenticated users:
<img src="https://user-images.githubusercontent.com/56620132/222934816-2083d794-f7f5-4ee8-8e97-97a38fdaff9f.png" alt="JWT works" /></p>

<p>The blacklist is empty as of now because we haven’t logged out:
<img src="https://user-images.githubusercontent.com/56620132/222934731-b456508a-06df-48c8-b45f-4db844ea53dc.png" alt="blacklist pre-logout" /></p>

<p>Now, we logout using /blacklist/logout with the JWT token stored in the Cookie header. The request returns a Set-Cookie header with an empty JWT cookie of Max-Age 0 to delete the existing client-side JWT cookie:
<img src="https://user-images.githubusercontent.com/56620132/222934706-d25092bb-2f12-45c1-badc-9f4ba2c39243.png" alt="logging out" /></p>

<p>The logout request has taken the JWT token in our cookie header and stored it into the blacklist:
<img src="https://user-images.githubusercontent.com/56620132/222934833-9a2982b1-679b-46d9-8167-7089cc731ca9.png" alt="blacklist post-logout" /></p>

<p>We can no longer access /api/person/ with the same JWT token because the server has checked that the JWT token is inside the blacklist and we should not be authenticated:
<img src="https://user-images.githubusercontent.com/56620132/222934752-17775720-04cc-4b32-b4b6-b07f109e3963.png" alt="JWT does not work" /></p>

<p>Finally, to test the cleaning feature, we wait for 2 minutes or so until the scheduled task runs to delete the JWT token inside the blacklist which has now expired:
<img src="https://user-images.githubusercontent.com/56620132/222934843-c2f74df5-82c7-44f3-a75b-9a30ea1aa36e.png" alt="blacklist cleaned" /></p>

<h3 id="cache-approach">Cache Approach</h3>
<p>Not finished implementing yet</p>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/fastpages/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="https://willcyber.github.io/fastpages/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/fastpages/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>An easy to use blogging platform with support for Jupyter Notebooks.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
